<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interim Planner</title>
    <style>
        #studentArea {
            display: grid;
            grid-template-columns: 200px repeat(5, 200px);
        }
    </style>
</head>
<body>
    Interim Plans
    <div id="headArea"></div>

    <div id ="studentArea"></div>

    <div id = "sessionsArea">
        Session Name: <input type="text"  id="sessionName"><br>
        Faculty: <input type="text"  id="sessionFaculty"><br>
        Student Lead: <input type="text" id="sessionStudentLead">
        Location: <input type="text" id="sessionLocation">
        <input type="button" id="addSession" value="Add Session">
    </div>

</body>

<script>


    window.addEventListener("load", (event) => {
        //sendRequest("/", "getSessions", "all" );
        sendRequest("/", "showStudents", "all" );
        addSessionButton();
    });

    studentIndex = 1;
    sessionsList = [];

        function addSessionButton(){
        let div = document.getElementById('addSession');
        let data = {
            "sessionName": document.getElementById("sessionName").value,
            "sessionFaculty": document.getElementById("sessionFaculty").value,
            "sessionStudentLead": document.getElementById("sessionStudentLead").value,
            "sessionLocation": document.getElementById("sessionLocation").value
        };
        div.addEventListener("click", function(){
            console.log("clicked");
            sendRequest("/", "addSession", data);
        })
    }

    function addStudentToList(student, divID="studentArea"){
        let div = document.getElementById(divID);
        studentIndex += 2;
        console.log("studentIndex", studentIndex);

        // student name
        sdiv = document.createElement("span");
        sdiv.innerHTML = student["studentName"];
        sdiv.style.gridRow = `${studentIndex} / span 2`;
        //sdiv.style.alignSelf = "center";
        sdiv.style.gridColumn = 1;
        sdiv.style.borderTop = '1px solid black';
        sdiv.style.marginTop = '5px';
        sdiv.style.paddingTop = '5px';
        sdiv.style.marginBottom = '5px';
        sdiv.style.paddingBottom = '5px';
        sdiv.style.borderBottom = '1px solid black';
        sdiv.style.backgroundColor = 'yellow';

        // student sesssions
        for (const session in student['sessions']){
            dayTime = session.split("_");
            chosenSession = student['sessions'][session];
            let i = dayTime[1] === "AM" ? 0 : 1;
            let j = 0;
            
            switch (dayTime[0]) {
                case "Monday":
                    j = 1;
                    break;
                case "Tuesday":
                    j = 2;
                    break;
                case "Wednesday":
                    j = 3;
                    break;
                case "Thursday":
                    j = 4;
                    break;
                case "Friday":
                    j = 5;
                    break;
                default:
                    j = 0;
            }
            ddiv = document.createElement("span");
            if (i === 0){
                ddiv.style.borderTop = '1px solid black';
                ddiv.style.marginTop = '5px';
                ddiv.style.paddingTop = '5px';
            } else {
                ddiv.style.borderBottom = '1px solid black';
                ddiv.style.marginBottom = '5px';
                ddiv.style.paddingBottom = '5px';
            }
            //ddiv.innerHTML = session;
            ddiv.appendChild(sessionDropdown(student['studentName'], session, chosenSession));

            // info
            ddiv.appendChild(infoTip(chosenSession));
            
            ddiv.style.gridRow = studentIndex+i;
            ddiv.style.gridColumn = j+1;
            console.log(session, i, j+1, chosenSession);

            div.append(ddiv);
        }


        div.append(sdiv);

    }

    function infoTip(sessionName){
        info = document.createElement('span');
        info.innerHTML = 'i';
        for (let session of sessionsList){
            if (session['sessionName'] === sessionName) {
                info.title = `${session['faculty']}, ${session['studentLead']}, ${session['location']}`;
            }
        }
        
        return info;
    }

    function sessionDropdown(student, sessionTime, chosenSession){
        let dropdown = document.createElement("select");
        let hasChosen = false;
        for (let session of sessionsList){
            const option = document.createElement("option");
            option.textContent = session['sessionName'];
            option.value = student + '@' + session['sessionName'] + '@' + sessionTime;
            if (session['sessionName'] === chosenSession){
                option.selected = true;
                hasChosen = true;
            }
            dropdown.appendChild(option);
        }

        // empty option
        if (chosenSession.trim() === ''){
            const option = document.createElement("option");
            option.textContent = ""
            option.value = student + '@' + ' ' + '@' + sessionTime;
            option.selected = true;
            dropdown.appendChild(option)
        }
        dropdown.addEventListener("change", function(){
            console.log(this.value);
            sendRequest("/", "updateStudentSession", this.value);
        })
        return dropdown;
    }



    function sendRequest(target, action, value="") {
        console.log("making request")
        let xR = new XMLHttpRequest();
        xR.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                
                console.log("Server Response:", this.responseText);
                data = JSON.parse(this.responseText);
                console.log("data:", data);
                console.log("data['item']:", data["item"]);
                
                //Handle responses
                if (data["item"] == "time") {
                    console.log("Got the time: ", data["status"]);
                    timeSlot.innerText = data["status"];
                }
                if (data["item"] == "photoResistor") {
                    console.log("Light Level: ", data["status"]);
                    MkspPhotoResistor.innerText = data["status"];
                }
                if (data["item"] == "students") {
                    // deviceTable.innerHTML = data['status'];
                    for (student of data["status"]){
                        console.log(student["studentName"]);
                        addStudentToList(student);
                    }
                }

                if (data["item"] == "everything") {
                    // deviceTable.innerHTML = data['status'];
                    sessionsList = data['status']['sessions'];
                    for (student of data["status"]['students']){
                        console.log(student["studentName"]);
                        addStudentToList(student);
                    }
                }
            }
        }
        let data = {};
        data["action"] = action;
        data["value"] = value;
        console.log("data:", data);
        xR.open("POST", target, true);
        xR.send(JSON.stringify(data));
    }


</script>
</html>